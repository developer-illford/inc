<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMPLI</title>
    <link rel="stylesheet" href="blog.css">

    <!-- bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Font Awesome link -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script src="https://kit.fontawesome.com/6c53136549.js" crossorigin="anonymous"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Big+Shoulders+Display:wght@100..900&family=Jomhuria&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap"
        rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" />
</head>

<body>
    <section class="row bed_menubar">
        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12 bed_menubar_col1">
            <div class="bed_menubar_item">
                <img src="../img/inc_nav_logo.webp" alt="">
            </div>
            <div class="bed_menubar_item">
                <h6>INC SHIPPING LLC</h6>
            </div>
        </div>
        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12 col-12 bed_menubar_col2">
            <div class="bed_menubar_item">
                <h6 id="displayUserName"></h6>
                <h6>&nbsp;&nbsp;&nbsp;<i class="fa-solid fa-user"></i></h6>
                <button onclick="logoutUser()"> Logout&nbsp; <i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </div>
    </section>
    <div class="row bed_body">
        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
            <form id="blogForm" method="post" enctype="multipart/form-data" action="publish.php">
                <div class="row">
                    <div class="col-xl-10 col-lg-10 col-md-10 col-sm-12 col-12">
                        <section class="bed_editor_area">
                            <label for="">Title :</label>
                            <input type="text" placeholder="Add Title" id="postTitle" name="title">
                            <!-- Create the editor container -->
                            <div class="bed_content_editor" id="bed_content_editor">
                                <br> <br>
                            </div>
                            <br>
                            <input type="hidden" id="content" name="content">
                            <label for="">Focus Keyphrase :</label>
                            <input type="text" placeholder="Add the Focus Keyphrase" id="focusKeyphrase"
                                name="focusKeyphrase">
                            <label for="">SEO Title :</label>
                            <input type="text" placeholder="Add SEO Title" id="seoTitle" name="seoTitle">
                            <label for="">Slug :</label>
                            <input type="text" placeholder="Add Slug" id="slug" name="slug">
                            <label for="">Meta Description :</label>
                            <input type="text" placeholder="Add Meta Description" id="metaDescription"
                                name="metaDescription">
                            <label for="">Canonical URL :</label>
                            <input type="text" placeholder="Add Canonical URL" id="canonicalUrl" name="canonicalUrl">
                            <input type="hidden" id="tags" name="tags">
                            <input type="hidden" id="isEditing" name="isEditing" value="">
                            <br>
                            <br>
                            <h6>Advanced options</h6>
                            <br>
                            <label for="">Scripts in head tag :</label>
                            <br>
                            <textarea rows="5" name="headSrcipts" id="headSrcipts" placeholder="Paste the code snippets to be placed inside the <head> tag"></textarea>
                            <br>
                            <label for="">Scripts in body tag :</label>
                            <br>
                            <textarea rows="5" name="bodySrcipts" id="bodySrcipts" placeholder="Paste the code snippets to be placed inside the <body> tag"></textarea>
                            <br>
                            <label for="">Structured data scripts :</label>
                            <br>
                            <textarea rows="5" name="structuredData" id="structuredData" placeholder="Paste the structured data code snippets to be placed inside the <head> tag"></textarea>
    
                            </section>
                    </div>

                    <div class="col-xl-2 col-lg-2 col-md-2 col-sm-12 col-12">
                        <div class="featured-image-card">
                            <div class="image-preview" id="image-preview">
                                <p>Add Featured Image</p>
                                <img id="featured-image" src="default-image.png" alt="Featured image">
                                <input type="hidden" id="featured-image-url" name="featured-image-url" value="">
                            </div>
                            <input type="file" id="image-input" accept="image/*" name="featuredImage"
                                style="display: none;">

                            <button type="button" id="upload-button">Click here to add or update</button>
                            <button type="button" id="remove-button">Remove featured image</button>
                        </div>

                        <div class="tags-card">
                            <p>Tags</p>
                            <div class="input-group">
                                <input type="text" id="tag-input" placeholder="Separate tags with commas">
                                <button type="button" id="add-tag-button">Add</button>
                            </div>
                            <div class="tags-container" id="tags-container"></div>
                        </div>

                        <div class="categories_card">
                            <p>Category</p>
                            <input type="radio" name="category" id="blog" value="blog"><label for="blog">&nbsp;
                                Blog</label>
                            <br>
                            <input type="radio" name="category" id="caseStudy" value="case study"><label
                                for="caseStudy">&nbsp; Case Study</label>
                        </div>

                        <!-- Robots Meta Dropdown -->
                        <div class="robots-meta-card">
                            <p>Robots Meta</p>
                            <select id="robotsMeta" name="robotsMeta">
                                <option value="index, follow">index, follow</option>
                                <option value="index, nofollow">index, nofollow</option>
                                <option value="noindex, follow">noindex, follow</option>
                                <option value="noindex, nofollow">noindex, nofollow</option>
                            </select>
                        </div>


                        <!-- Hidden input for robotsMeta to ensure it's submitted -->
                        <input type="hidden" id="robotsMetaInput" name="robotsMetaInput">

                        <!-- Location input fields -->
                        <div class="location-card">
                            <p>Location</p>
                            <input type="text" id="geoRegionInput" placeholder="Region Code (e.g., AE)" />
                            <input type="text" id="geoPlacenameInput" placeholder="Placename (e.g., Atmar)" />
                            <input type="text" id="geoLatInput" placeholder="Enter Latitude" />
                            <input type="text" id="geoLonInput" placeholder="Enter Longitude" />
                        </div>

                        <!-- Hidden inputs for geo tags -->
                        <input type="hidden" id="geoRegion" name="geoRegion" value="">
                        <input type="hidden" id="geoPlacename" name="geoPlacename" value="">
                        <input type="hidden" id="geoPosition" name="geoPosition" value="">
                        <input type="hidden" id="ICBM" name="ICBM" value="">


                        <div class="actions_card">
                            <p>Publish</p>
                            <h4>Visibility:</h4>
                            <label>
                                <input type="radio" name="visibility" value="public">
                                Public
                            </label>
                            <label>
                                <input type="radio" name="visibility" value="private">
                                Private
                            </label>
                            <br><br>
                            <button type="button" id="publish">Publish</button>
                        </div>

                        <!-- Modal for alt text -->
                        <!-- Modal for alt text -->
                        <div id="altTextModal" style="display:none;">
                            <label for="altTextInput">Enter Alt Text:</label>
                            <input type="text" id="altTextInput" />
                            <button type="button" id="saveAltTextButton">Save Alt Text</button>
                            <!-- Changed to type="button" -->
                        </div>

                    </div>
                </div>
            </form>
        </div>
    </div>

    <style>
        #altTextModal {
            position: fixed;
            background-color: white;
            border: 1px solid #ccc;
            padding: 20px;
            z-index: 1000;
            display: none;
        }
    </style>

    <script>
        // When the page loads, populate the hidden input field with the current image src
        window.onload = function () {
            var featuredImage = document.getElementById('featured-image');
            if (featuredImage) {
                document.getElementById('featured-image-url').value = featuredImage.src;
            }
        };
    </script>

    <!-- bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
    <!-- Include the Quill library -->
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script src="blog.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.2/firebase-app.js"></script>
    <!-- Import Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/8.4.2/firebase-auth.js"></script>
    <script src="fireconfig.js"></script> <!-- Your Firebase config file -->

    <script>

        // Firebase Authentication to check if a user is logged in
        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
                // User is signed in, display the user name
                document.getElementById('displayUserName').textContent = user.email;
            } else {
                // No user is signed in, redirect to login page
                window.location.href = 'login.html';
            }
        });

        // Function to handle logout
        function logoutUser() {
            if (confirm('Are you sure you want to logout?')) {
                firebase.auth().signOut().then(() => {
                    window.location.href = 'login.html';
                }).catch((error) => {
                    console.error('Error logging out: ', error);
                });
            }
        }
    </script>

    <script>
        document.getElementById('publish').addEventListener('click', function () {
            var featuredImage = document.getElementById('featured-image');
            if (featuredImage) {
                document.getElementById('featured-image-url').value = featuredImage.src;
            }
            // Get the content from the editor
            document.getElementById('content').value = quill.root.innerHTML;

            // Get the selected robots meta value
            const robotsMeta = document.getElementById('robotsMeta').value;

            // Set the hidden input value to the selected robots meta value
            document.getElementById('robotsMetaInput').value = robotsMeta;

            // Submit the form
            document.getElementById('blogForm').submit();

            // Collect tags
            const tagsContainer = document.getElementById('tags-container');
            const tags = Array.from(tagsContainer.children).map(tagElement => {
                // Ensure only one `#` is present
                let tag = tagElement.firstChild.textContent;
                tag = tag.replace(/^#+/, ''); // Remove all leading #
                tag = '#' + tag.trim(); // Add a single #
                return tag;
            });
            document.getElementById('tags').value = tags.join(',');


            // Get geo-location values and fill in hidden inputs
            var region = document.getElementById('geoRegionInput').value.trim();
            var placename = document.getElementById('geoPlacenameInput').value.trim();
            var lat = document.getElementById('geoLatInput').value.trim();
            var lon = document.getElementById('geoLonInput').value.trim();

            // if (!region || !placename || !lat || !lon) {
            //     alert('Please fill in all the location fields.');
            //     return;
            // }

            document.getElementById('geoRegion').value = region;
            document.getElementById('geoPlacename').value = placename;
            document.getElementById('geoPosition').value = lat + ';' + lon;
            document.getElementById('ICBM').value = lat + ', ' + lon;


            // Check if the post is new or being edited
            const isEditing = localStorage.getItem('editPostData') !== null;

            if (!isEditing) {  // Slug check only for new posts
                // If creating a new post, check if a file with the same slug already exists
                const slug = document.getElementById('slug').value.trim();
                if (slug) {
                    fetch('check_slug.php?slug=' + encodeURIComponent(slug))
                        .then(response => response.json())
                        .then(data => {
                            if (data.exists) {
                                alert('A file with this slug name already exists. Please choose a different slug.');
                            } else {
                                // Proceed with publishing if no file with the same slug exists
                                document.getElementById('blogForm').submit();
                            }
                        })
                        .catch(error => console.error('Error checking slug:', error));
                } else {
                    alert('Slug cannot be empty.');
                }
            } else {
                // For existing posts (editing), skip the slug check and submit the form directly
                document.getElementById('blogForm').submit();
                localStorage.removeItem('editPostData');
            }
        });

        // Load the post data for editing
        document.addEventListener('DOMContentLoaded', function () {
            const editPostData = localStorage.getItem('editPostData');

            if (editPostData) {
                const postData = JSON.parse(editPostData);


                // Populate the canonical URL field
                if (postData.canonicalUrl) {
                    document.getElementById('canonicalUrl').value = postData.canonicalUrl;
                }

                // Populate the form fields with the post data
                document.getElementById('postTitle').addEventListener('input', function () {
                    let title = this.value;
                    let slug = title.toLowerCase() // Convert to lowercase
                        .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                        .trim() // Remove leading/trailing spaces
                        .replace(/\s+/g, '-') // Replace spaces with hyphens
                        .replace(/-+/g, '-'); // Replace multiple hyphens with single hyphen

                    document.getElementById('slug').value = slug;
                });
                quill.root.innerHTML = postData.content; // Populate the Quill editor
                document.getElementById('focusKeyphrase').value = postData.focusKeyphrase;
                document.getElementById('seoTitle').value = postData.seoTitle;
                document.getElementById('slug').value = postData.slug;
                document.getElementById('metaDescription').value = postData.metaDescription;
                document.getElementById('tags').value = postData.tags;
                document.getElementById('postTitle').value = postData.title;
                document.getElementById('headSrcipts').value = postData.headScripts || ''; // Load head scripts
                document.getElementById('bodySrcipts').value = postData.bodyScripts || ''; // Load body scripts
                document.getElementById('structuredData').value = postData.structuredData || ''; // Load structured Data

                // Populate the featured image
                document.getElementById('featured-image').src = postData.featuredImage;

                // Populate tags container
                const tagsContainer = document.getElementById('tags-container');
                postData.tags.split(',').forEach(tag => {
                    const tagElement = document.createElement('div');
                    tagElement.classList.add('tag');

                    // Make the tags editable by adding them back to the input
                    const removeButton = document.createElement('span');
                    removeButton.textContent = ' x';
                    removeButton.classList.add('remove-tag');
                    removeButton.onclick = function () {
                        tagsContainer.removeChild(tagElement);
                    };
                    tagElement.textContent = tag.startsWith('#') ? tag : `#${tag}`;
                    tagElement.appendChild(removeButton);
                    tagsContainer.appendChild(tagElement);
                });

                // Populate category
                const categoryOptions = document.getElementsByName('category');
                categoryOptions.forEach(option => {
                    if (option.value.toLowerCase() === postData.category.toLowerCase()) {
                        option.checked = true;
                    }
                });


                // Prepopulate robots meta dropdown based on saved value
                if (postData.robotsMeta) {
                    document.getElementById('robotsMeta').value = postData.robotsMeta;
                }

                // Populate geo tags if they exist in postData
                if (postData.geoRegion) {
                    document.getElementById('geoRegionInput').value = postData.geoRegion;
                } else {
                    document.getElementById('geoRegionInput').value = '';
                }

                if (postData.geoPlacename) {
                    document.getElementById('geoPlacenameInput').value = postData.geoPlacename;
                } else {
                    document.getElementById('geoPlacenameInput').value = '';
                }

                if (postData.geoPosition) {
                    const [lat, lon] = postData.geoPosition.split(';');
                    document.getElementById('geoLatInput').value = lat || '';
                    document.getElementById('geoLonInput').value = lon || '';
                } else {
                    document.getElementById('geoLatInput').value = '';
                    document.getElementById('geoLonInput').value = '';
                }

                if (postData.ICBM) {
                    const [lat, lon] = postData.ICBM.split(', ');
                    document.getElementById('geoLatInput').value = lat || '';
                    document.getElementById('geoLonInput').value = lon || '';
                }



                // Populate visibility
                const visibilityOptions = document.getElementsByName('visibility');
                visibilityOptions.forEach(option => {
                    if (option.value === postData.visibility) {
                        option.checked = true;
                    }
                });

                // Make title and slug non-editable
                document.getElementById('postTitle').readOnly = true;
                document.getElementById('slug').readOnly = true;

                // Store the data in temp.json
                fetch('store_temp_data.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(postData)
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.status !== 'success') {
                            console.error('Error storing temp data:', result);
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        });
        // When the publish button is clicked, make sure the selected robots meta is saved
        document.getElementById('publish').addEventListener('click', function () {
            const robotsMeta = document.getElementById('robotsMeta').value;
            document.getElementById('robotsMetaInput').value = robotsMeta;

            // Proceed with the rest of the form submission logic
            document.getElementById('blogForm').submit();
        });
    </script>
    <script>
        document.getElementById('postTitle').addEventListener('input', function () {
            let title = this.value;
            let slug = title.toLowerCase() // Convert to lowercase
                .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                .trim() // Remove leading/trailing spaces
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .replace(/-+/g, '-'); // Replace multiple hyphens with single hyphen

            document.getElementById('slug').value = slug;

            // Auto-generate the canonical URL
            let canonicalUrl = 'https://incshipping.com/blog/' + slug;

            // Set the canonical URL value
            document.getElementById('canonicalUrl').value = canonicalUrl;
        });

        document.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {  // Check if the Enter key is pressed
                document.getElementById('add-tag-button').click();  // Trigger the button click
                event.preventDefault();
            }
        });
    </script>
    <script>
        const ImageBlot = Quill.import('formats/image');

        class CustomImageBlot extends ImageBlot {
            static create(value) {
                let node = super.create(value.url || value);  // Ensure the value can handle both strings and objects
                node.setAttribute('src', value.url || value); // Ensure the 'src' attribute is set correctly

                // Set alt text if provided
                if (value.alt) {
                    node.setAttribute('alt', value.alt);
                }
                return node;
            }

            static value(domNode) {
                return {
                    url: domNode.getAttribute('src'),
                    alt: domNode.getAttribute('alt'),
                };
            }

            static formats(domNode) {
                let formats = super.formats(domNode);
                formats.alt = domNode.getAttribute('alt') || '';
                return formats;
            }

            format(name, value) {
                if (name === 'alt') {
                    if (value) {
                        this.domNode.setAttribute('alt', value);
                    } else {
                        this.domNode.removeAttribute('alt');
                    }
                } else {
                    super.format(name, value);
                }
            }
        }

        Quill.register(CustomImageBlot, true);
    </script>

    <script>
        // When an image in the editor is clicked, show the modal to add alt text
        document.querySelector('.ql-editor').addEventListener('click', function (e) {
            if (e.target.tagName === 'IMG') {
                const img = e.target;
                const altTextModal = document.getElementById('altTextModal');
                const altTextInput = document.getElementById('altTextInput');
                const saveAltTextButton = document.getElementById('saveAltTextButton');

                // Pre-fill the input with the current alt text
                altTextInput.value = img.getAttribute('alt') || '';

                // Show the modal near the image
                altTextModal.style.display = 'block';
                altTextModal.style.top = e.clientY + 'px';
                altTextModal.style.left = e.clientX + 'px';

                // Prevent the default action when the "Save Alt Text" button is clicked
                saveAltTextButton.onclick = function (e) {
                    e.preventDefault(); // Prevent any default form submission or page reload

                    const altText = altTextInput.value;
                    // Update the image alt text
                    img.setAttribute('alt', altText);

                    // Hide the modal
                    altTextModal.style.display = 'none';
                };
            }
        });

        // Hide the modal if clicked outside
        document.addEventListener('click', function (e) {
            const altTextModal = document.getElementById('altTextModal');
            if (!altTextModal.contains(e.target) && !e.target.closest('.ql-editor img')) {
                altTextModal.style.display = 'none';
            }
        });


    </script>


</body>

</html>